/*
 2015-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,v,w){c instanceof String&&(c=String(c));for(var g=c.length,m=0;m<g;m++){var q=c[m];if(v.call(w,q,m,c))return{i:m,v:q}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,v,w){if(c==Array.prototype||c==Object.prototype)return c;c[v]=w.value;return c};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,c,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var v=0;v<c.length;++v){var w=c[v];if(w&&w.Math==Math)return w}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(c,v){var w=$jscomp.propertyToPolyfillSymbol[v];if(null==w)return c[v];w=c[w];return void 0!==w?w:c[v]};
$jscomp.polyfill=function(c,v,w,g){v&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(c,v,w,g):$jscomp.polyfillUnisolated(c,v,w,g))};$jscomp.polyfillUnisolated=function(c,v,w,g){w=$jscomp.global;c=c.split(".");for(g=0;g<c.length-1;g++){var m=c[g];if(!(m in w))return;w=w[m]}c=c[c.length-1];g=w[c];v=v(g);v!=g&&null!=v&&$jscomp.defineProperty(w,c,{configurable:!0,writable:!0,value:v})};
$jscomp.polyfillIsolated=function(c,v,w,g){var m=c.split(".");c=1===m.length;g=m[0];g=!c&&g in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var q=0;q<m.length-1;q++){var b=m[q];if(!(b in g))return;g=g[b]}m=m[m.length-1];w=$jscomp.IS_SYMBOL_NATIVE&&"es6"===w?g[m]:null;v=v(w);null!=v&&(c?$jscomp.defineProperty($jscomp.polyfills,m,{configurable:!0,writable:!0,value:v}):v!==w&&($jscomp.propertyToPolyfillSymbol[m]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(m):$jscomp.POLYFILL_PREFIX+m,m=
$jscomp.propertyToPolyfillSymbol[m],$jscomp.defineProperty(g,m,{configurable:!0,writable:!0,value:v})))};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(v,w){return $jscomp.findInternal(this,v,w).v}},"es6","es3");
(function(c,v){var w=0,g={},m={},q={};c.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=w;w+=1;this.eventNamespace=".locationselector"},_init:function(){var b=c(this.element),a=this.options,d=b.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=b;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var b=this._deserialize();this._renderWidget();var a="#"+this.fieldname,d=this.options;c(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var f=c(a+"_L0__row");if(f.length){var h=[];for(y in g){var p=g[y];0===p.l&&(p.i=y,h.push(p))}h.sort(function(A,B){return A.n.localeCompare(B.n)});for(var l=c(a+"_L0"),r=0,z=h.length;r<z;r++){p=h[r];var y=p.i;p='<option value="'+
y+'">'+p.n+"</option>";l.append(p)}f.removeClass("hide").show();f=c(a+"_L0__row1");f.length&&f.removeClass("hide").show()}var k=this;f=b.L0;var x=b.L1,u=b.L2,t=b.L3,n=b.L4,e=b.L5;f?k.lxSelect(0,f,!0).then(function(){x||u?k.lxSelect(1,x||u,!0).then(function(){u||t?k.lxSelect(2,u||t,!0).then(function(){t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):
e&&k.lxSelect(5,e,!0)}):t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):u||t?k.lxSelect(2,u||t,!0).then(function(){t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,
e,!0)}):t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):x||u?k.lxSelect(1,x||u,!0).then(function(){u||t?k.lxSelect(2,u||t,!0).then(function(){t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,
e,!0)}):e&&k.lxSelect(5,e,!0)}):t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):u||t?k.lxSelect(2,u||t,!0).then(function(){t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):
e&&k.lxSelect(5,e,!0)}):t||n?k.lxSelect(3,t||n,!0).then(function(){n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0)}):n||e?k.lxSelect(4,n||e,!0).then(function(){e&&k.lxSelect(5,e,!0)}):e&&k.lxSelect(5,e,!0);this.lx=[f,x,u,t,n,e].join("|");c(a+"_address").val(b.address);c(a+"_address__row").removeClass("hide").show();c(a+"_address__row1").removeClass("hide").show();c(a+"_postcode").val(b.postcode);c(a+"_postcode__row").removeClass("hide").show();c(a+"_postcode__row1").removeClass("hide").show();
c(a+"_lat").val(b.lat).latloninput({type:"lat",mode:d.latlonMode});c(a+"_lat__row").removeClass("hide").show();c(a+"_lat__row1").removeClass("hide").show();c(a+"_lon").val(b.lon).latloninput({type:"lon",mode:d.latlonMode});c(a+"_lon__row").removeClass("hide").show();c(a+"_lon__row1").removeClass("hide").show();f=c(a+"_map_icon__row").removeClass("hide").show();b.lat||b.lon||b.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&f.is(":visible")&&
"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var b=this.fieldname,a="#"+b,d=this.options.reverseLx,f=c(a+"_map_icon__row .map_wrapper");f.attr("id",this.fieldname+"_map_wrapper");var h=c(a+"__row"),p=this.input.next(".error_wrapper"),l=c(a+"_map_icon__row"),r=c(a+"_L0__row"),z=c(a+"_postcode__row");if(h.is(".control-group, .form-row")){b=c(a+"_L1__row");var y=
c(a+"_L2__row"),k=c(a+"_L3__row"),x=c(a+"_L4__row"),u=c(a+"_L5__row"),t=c(a+"_address__row"),n=c(a+"_lat__row"),e=c(a+"_lon__row");a=c(a+"_latlon_toggle__row");d?h.hide().after(f).after(l).after(a).after(e).after(n).after(r).after(b).after(y).after(k).after(x).after(u).after(z).after(t).after(p):h.hide().after(f).after(l).after(a).after(e).after(n).after(z).after(t).after(u).after(x).after(k).after(y).after(b).after(r).after(p)}else h.parent().is(".inline-form")?h.show():(c(a+"__row1").hide(),h.hide().after(p),
l.detach(),h.siblings('[id^="'+b+'"][id$="__row"]').last().after(f).after(l));if(p.length)p.one("click"+this.eventNamespace,function(){var A=c(this);A.fadeOut("slow",function(){A.remove()})})},_lxSelectFinal:function(b){b?this._serialize():this._collectData();this._zoomMap()},lxSelect:function(b,a,d){var f=c.Deferred(),h=this,p="#"+h.fieldname,l=h.options,r=c(p+"_L"+b),z;a?(r.val(a).trigger("change","implicit"),r.hasClass("multiselect")&&r.multiselect("instance")&&r.multiselect("refresh")):a=parseInt(r.val(),
10);if(0===b){var y=h._readLabels(a),k=m.d,x=["1","2","3","4","5"],u,t,n;y.then(function(J){for(n=0;5>n;n++)z=x[n],u=J[z]||k[z],e=p+"_L"+z,r=c(e),t=l.showLabels?r.hasClass("required")?"<div>"+u+':<span class="req"> *</span></div>':u+":":"",c(e+"__row label").html(t),c(e+"__row1 label").html(t),c(e+' option[value=""]').html(i18n.select+" "+u),r.hasClass("multiselect")&&r.multiselect("instance")&&r.multiselect("refresh")})}y=l.hideLx;for(z=b+1;6>z;z++){var e=p+"_L"+z;y?(c(e+"__row").hide(),c(e+"__row1").hide()):
c(e+" option").remove('[value != ""]');c(e).val("").trigger("change","implicit")}if(a){var A=!1,B=b+1,F=c(p+"_L"+B+"__row");F.length||(A=!0,B++,F=c(p+"_L"+B+"__row"));if(F.length){var C;y=!1;if(c(p+"_L"+b+' option[value="'+a+'"]').hasClass("missing")){var D=g[a];D.i=a;var G=[D]}else for(C in G=[],y=!0,g)if(g[C].f==a){y=!1;break}h._readHierarchy(y,a,B,A).then(function(){if(0==G.length)for(C in g)D=g[C],D.f==a&&(D.i=C,G.push(D));var J=G.length;if(J){G.sort(function(K,L){return K.n.localeCompare(L.n)});
var H=p+"_L"+B;var E=c(H),I=c(H+' option[value=""]').html();c(H+" option").remove('[value != ""]');C=null;for(n=0;n<J;n++)D=G[n],C=D.i,H=a==C?' selected="selected"':"",A=D.l==B?"":' class="missing"',H='<option value="'+C+'"'+H+A+">"+D.n+"</option>",E.append(H);F.removeClass("hide").show();c(p+"_L"+B+"__row1").removeClass("hide").show();E.hasClass("multiselect")&&(I={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:I,multiple:!1},E.hasClass("search")?(E.multiselect(I).multiselectfilter({label:"",
placeholder:i18n.search}),c(".ui-multiselect-header").show()):(I.header=!1,E.multiselect(I)));E=h.data["L"+B];I=G.map(function(K){return K.i});E&&-1!=I.indexOf(""+E)?h.lxSelect(B,E,d):1==J&&C&&h.lxSelect(B,C,d)}h._lxSelectFinal(d);f.resolve()})}else h.useGeocoder&&!d&&h._geocodeDecision(),h._lxSelectFinal(d),f.resolve()}else h._lxSelectFinal(d),f.resolve();return f.promise()},_collectData:function(b){var a=this.data,d="#"+this.fieldname,f=this._lookupParent(),h=c(d+"_address").val(),p=c(d+"_postcode").val();
a.address=h;a.postcode=p;if(a.specific)a.id=a.specific,a.parent=f;else{var l=a.lat,r=a.lon,z=a.wkt;h||p||l||r||z?(a.id=null,a.parent=f):(a.id=f,a.parent=null)}this._serialize();c(d+"_lat").val(a.lat).trigger("setvalue");c(d+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",b&&"user"||"implicit")},_collectLx:function(){var b=this.data,a="#"+this.fieldname,d;for(d=0;6>d;d++){var f=c(a+"_L"+d);f.length&&(f=f.val(),
b["L"+d]=f?parseInt(f,10):null)}this._serialize()},_hasData:function(){var b=this.data,a=!1;b.specific||b.address||b.postcode||b.lat||b.lon||b.wkt?a=!0:[b.L0,b.L1,b.L2,b.L3,b.L4,b.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var b=this.data,a,d=5;-1<d;d--)if(a=b["L"+d])return a;return(b=g.d)?b.i:null},_readLabels:function(b){b||(b="d");var a=c.Deferred(),d=m[b];if(d==v){var f=S3.Ap.concat("/gis/hdata/"+b);c.ajaxS3({url:f,dataType:"json",success:function(h){d=
{};try{for(var p in h)d[p]=h[p];m[b]=d}catch(l){}a.resolve(d)},error:function(h,p,l){(h="UNAUTHORIZED"==l?i18n.gis_requires_login:h.responseText)&&s3_debug(h);a.reject()}})}else a.resolve(d);return a.promise()},_readHierarchy:function(b,a,d,f){var h=""+a+";"+d+";"+f,p=q[h];if(p!==v)return p;var l=c.Deferred();if(b){b="#"+this.fieldname;var r=c(b+"_L"+d),z=!1;r.hide();if(r.hasClass("multiselect")){z=!0;var y=c(b+"_L"+d+"__row button").hide()}var k=c(b+"_L"+d+"__throbber").removeClass("hide").show();
a=f?S3.Ap.concat("/gis/ldata/"+a+"/"+d):S3.Ap.concat("/gis/ldata/"+a);c.ajaxS3({url:a,dataType:"json",success:function(x){for(var u in x)g[u]=x[u];k.hide();z?y.removeClass("hide").show():r.removeClass("hide").show();l.resolve()},error:function(x,u,t){if(x="UNAUTHORIZED"==t?i18n.gis_requires_login:x.responseText)s3_debug(x),S3.showAlert(x,"error");k.hide();z?y.removeClass("hide").show():r.removeClass("hide").show();l.reject()}})}else l.resolve();return p=q[h]=l.promise()},_geocodeDecision:function(){var b=
"#"+this.fieldname,a=this.data;this._collectData();if(a.address){a=["1","2","3","4","5"];for(var d=0,f;5>d;d++)if(f=c(b+"_L"+a[d]),f.length&&!f.val()&&1<f[0].options.length)return;c(b+"_geocode .geocode_success,"+b+"_geocode .geocode_fail").hide();var h=this;a=this.eventNamespace;this.input.data("manually_geocoded")?c(b+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+a,function(){c(this).hide();h._geocode()}):this._geocode()}},_geocode:function(){var b=this.fieldname,a=this,d=
"#"+b,f=c(d+"_geocode .geocode_fail").hide(),h=c(d+"_geocode .geocode_success").hide(),p=c(d+"_geocode .throbber").removeClass("hide").show(),l=this.data;d={address:l.address};for(var r="postcode L0 L1 L2 L3 L4 L5".split(" "),z=0,y,k;7>z;z++)y=r[z],(k=l[y])&&(d[y]=k);r=S3.Ap.concat("/gis/geocode");c.ajaxS3({url:r,type:"POST",data:d,dataType:"json",success:function(x){var u=x.lat,t=x.lon;if(u||t){l.lat=parseFloat(u);l.lon=parseFloat(t);a._collectData();u=S3.gis;if(u.maps&&(t=u.maps["location_selector_"+
b])){x=t.s3.draftLayer;x.removeAllFeatures();var n=new OpenLayers.Geometry.Point(l.lon,l.lat);n.transform(u.proj4326,t.getProjectionObject());u=new OpenLayers.Feature.Vector(n);x.addFeatures([u]);a._zoomMap()}p.hide();h.html(i18n.address_mapped).removeClass("hide").show()}else p.hide(),f.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(x)},error:function(x,u,t){x="UNAUTHORIZED"==t?i18n.gis_requires_login:x.responseText;p.hide();f.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(x)}})},_geocodeReverse:function(){var b=this,a="#"+this.fieldname,d=c(a+"_geocode .geocode_fail").hide(),f=c(a+"_geocode .geocode_success").hide(),h=c(a+"_geocode .throbber").removeClass("hide").show();a=this.data;a={lat:a.lat,lon:a.lon};var p=S3.Ap.concat("/gis/geocode_r");c.ajaxS3({async:!1,url:p,type:"POST",data:a,dataType:"json",success:function(l){l.L0?(b.useGeocoder=!1,b.lxSelect(0,l.L0).then(function(){l.L1&&b.lxSelect(1,l.L1).then(function(){l.L2&&b.lxSelect(2,l.L2).then(function(){l.L3&&
b.lxSelect(3,l.L3).then(function(){l.L4&&b.lxSelect(4,l.L4).then(function(){l.L5&&b.lxSelect(5,l.L5)})})})})}),b.useGeocoder=!0,h.hide(),f.html(i18n.location_found).removeClass("hide").show()):(h.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(l,r,z){l="UNAUTHORIZED"==z?i18n.gis_requires_login:l.responseText;h.hide();d.html(i18n.location_not_found).removeClass("hide").show();s3_debug(l)}})},_latlonInput:function(){var b=this.fieldname,a=this.data,d="#"+b,f=c(d+"_lat").val();
d=c(d+"_lon").val();f||d?(f=f?parseFloat(f):0,d=d?parseFloat(d):0,a.lat=f,a.lon=d,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();f=S3.gis;f.maps&&(b=f.maps["location_selector_"+b])&&(d=b.s3.draftLayer,d.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(f.proj4326,b.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.addFeatures([a]),b.s3.lastDraftFeature=
a),this._zoomMap())},_showMap:function(b){var a=this.fieldname,d=this.eventNamespace,f=this,h="#"+a;c(h+"_map_icon").unbind(d).bind("click"+d,function(){f._hideMap()});c(h+"_map_icon span").html(i18n.hide_map);d=c(h+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&b&&c("html,body").animate({scrollTop:d.offset().top},250);var p=this.input;c.when(this._jsLoaded()).then(function(){var l=S3.gis,r="location_selector_"+a;var z=l.maps[r]?l.maps[r]:l.show_map(r);f._zoomMap();var y=
f.data;r=y.lat;var k=y.lon,x=y.wkt;if(r||k||x)z.s3.draftLayer.removeAllFeatures(),x!=v&&x?(r={internalProjection:z.getProjectionObject(),externalProjection:l.proj4326},r=(new OpenLayers.Format.WKT(r)).read(x)):(r=new OpenLayers.Geometry.Point(parseFloat(k),parseFloat(r)),r.transform(l.proj4326,z.getProjectionObject()),r=new OpenLayers.Feature.Vector(r)),z.s3.draftLayer.addFeatures([r]),z.s3.lastDraftFeature=r;r=z.controls;k=0;for(var u=r.length;k<u;k++)if("OpenLayers.Control.DrawFeature"==r[k].CLASS_NAME){var t=
r[k];break}t&&(z.s3.pointPlaced=function(n){c(h+"_geocode .geocode_fail").hide();c(h+"_geocode .geocode_success").hide();var e=n.geometry;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)n=e.getBounds().getCenterLonLat(),n.transform(z.getProjectionObject(),l.proj4326),y.wkt=null,y.lat=n.lat,y.lon=n.lon,!y.address&&f.useGeocoder&&f._geocodeReverse();else{e={internalProjection:z.getProjectionObject(),externalProjection:l.proj4326};y.radius=null;var A=new OpenLayers.Geometry.LinearRing(n.geometry.components[0].components);
A=new OpenLayers.Geometry.Polygon([A]);if(1E3==A.getVertices().length){var B=(new OpenLayers.Feature.Vector(A,null)).geometry.getBounds();A=B.right;var F=(B.bottom+B.top)/2;B=new OpenLayers.Geometry.Point((B.left+A)/2,F);A=new OpenLayers.Geometry.Point(A,F);A=new OpenLayers.Geometry.LineString([B,A]);A=parseFloat(A.getLength());y.radius=A}x=(new OpenLayers.Format.WKT(e)).write(n);y.wkt=x;y.lat=null;y.lon=null}p.data("manually_geocoded",!0);f._collectData(!0);f._removeErrors();"sub_"==a.substring(0,
4)&&p.parent().find("div.map_wrapper").trigger("change")})},function(l){s3_debug(l)},function(l){s3_debug(l)})},_hideMap:function(){var b=this.fieldname,a=this.eventNamespace,d="#"+b,f=this;c(d+"_map_icon").unbind(a).bind("click"+a,function(p){f._showMap(p)});c(d+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var h=i18n.show_map_view;else if(h=i18n.show_map_add,S3.gis.maps&&(b=S3.gis.maps["location_selector_"+b]))b.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",
!1),this._collectData();c(d+"_map_icon span").html(h)},_zoomMap:function(b){var a=this.fieldname,d=S3.gis;if(d.maps&&(a=d.maps["location_selector_"+a])){var f=this.data;d=f.lat;var h=f.lon;f=f.wkt;if(d&&h)d=OpenLayers.Bounds.fromArray([h,d,h,d]);else if(f)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(f))).geometry.getBounds();else{b||(b=this._lookupParent()||"d");d=g[b].b;if(!d||!d.length)for(h=g[b].f,b=4;h&&b&&(b--,h=g[h],!(d=h.b)&&0!==h.l);)h=h.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&
S3.gis.zoomBounds(a,d,this.options.minBBOX)}},_validate:function(){var b=this.fieldname;this._removeErrors();b="#"+b;var a=this.data,d=this.options.featureRequired;if(d){var f=!1;switch(d){case "latlon":f=a.lat||a.lon;break;case "wkt":f=a.wkt;break;default:f=a.lat||a.lon||a.wkt}if(!f)return S3.fieldError(b+"_map_icon",i18n.map_feature_required),!1}var h=a.id;d="address L5 L4 L3 L2 L1 L0".split(" ");f=function(r){return r.hasClass("multiselect")?r.next("button.ui-multiselect").is(":visible"):r.is(":visible")};
if(h){if(!g[h])return!0;var p=g[h].l;for(a=0;a<6-p;a++){h=b+"_"+d[a];var l=c(h);if(l.length&&l.hasClass("required")&&f(l))return S3.fieldError(h,i18n.enter_value),!1}}else{if(a.lat||a.lon||a.wkt||a.address||a.postcode)return!0;for(a=0;7>a;a++)if(h=b+"_"+d[a],l=c(h),l.length&&l.hasClass("required")&&f(l))return S3.fieldError(h,i18n.enter_value),!1}return!0},_serialize:function(){var b=JSON.stringify(this.data);this.input.val(b);return b},_deserialize:function(){var b=this.input.val();return this.data=
JSON.parse(b)},_storeHierarchyData:function(b,a){var d;if(a)for(d in a)g[d]=a[d];if(b)for(d in b)m[d]=b[d]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=v?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},_removeErrors:function(b){b||(b="#"+this.fieldname,b=b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon");c(b).siblings(".error").remove()},
_bindEvents:function(){var b=this.fieldname,a=this.eventNamespace,d=this,f="#"+b;c(f+"_L0").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(0)});c(f+"_L1").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(1)});c(f+"_L2").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(2)});c(f+"_L3").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(3)});c(f+"_L4").bind("change"+a,function(){d._removeErrors(this);d.lxSelect(4)});c(f+"_L5").bind("change"+a,function(){d._removeErrors(this);
d.lxSelect(5)});c(f+"_address,"+f+"_postcode").bind("change"+a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});c(f+"_lat,"+f+"_lon").bind("change"+a,function(){d._latlonInput()});c(f+"_latlon_toggle").bind("click"+a,function(){var p=c(this).data("mode")||d.options.latlonMode;if("dms"==p){p="decimal";var l=i18n.latlon_mode.dms}else p="dms",l=i18n.latlon_mode.decimal;c(f+"_lat").latloninput("option",{mode:p});c(f+"_lon").latloninput("option",{mode:p});c(this).html(l).data("mode",
p)});if("sub_"==b.substring(0,4))this.input.closest(".inline-form").bind("validate"+a+this.id,function(p){d._validate()||p.preventDefault()});else{var h=this.input.closest("form");h.bind("submit"+a+this.id,function(p){p.preventDefault();d._validate()&&h.unbind(a+d.id).submit()})}return!0},_unbindEvents:function(){var b="#"+this.fieldname,a=this.eventNamespace;c(b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon,"+b+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);
this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(c,v){var w=0;c.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=w;w+=1;this.eventNamespace=".latloninput"},_init:function(){c(this.element).hide();this.refresh()},_destroy:function(){c(this.element).show();c.Widget.prototype.destroy.call(this)},_setOption:function(g,m){this._super(g,m);"mode"==g&&this.refresh()},refresh:function(){this._unbindEvents();var g=c(this.element),m=this.options;this.defaultValue=g.val();
if(!this.input){var q=c("<div>").hide().insertAfter(g),b=c('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var a=m.labels,d=c('<input type="text" class="integer dms-input" size="5">'),f=c('<span class="dms-label">'+a.deg+"</span>"),h=c('<input type="text" class="integer dms-input" size="5">'),p=c('<span class="dms-label">'+a.min+"</span>"),l=c('<input type="text" class="double dms-input" size="8">');a=c('<span class="dms-label">'+a.sec+"</span>");this.degInput=d;this.minInput=
h;this.secInput=l;this.dmsInput=d=c("<span>").append(d).append(f).append(h).append(p).append(l).append(a).hide();this.input=q.append(b).append(d).show()}this._removeErrors();"dms"==m.mode?(g=this._getDMS(),this.degInput.val(g.d),this.minInput.val(g.m),this.secInput.val(g.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(g.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var g=c(this.element).val();if(isNaN(parseFloat(g))||!isFinite(g))return{d:"",
m:"",s:""};var m=Math.abs(g);m=60*(m-parseInt(m,10));if(1E-10>Math.abs(m-Math.round(m))){m=Math.round(m);var q=0}else q=60*(m-parseInt(m,10)),1E-10>Math.abs(q-Math.round(q))&&(q=Math.round(q));return{d:parseInt(g,10),m:parseInt(m,10),s:q}},_showError:function(g,m){"all"==g?this.input.find("input").addClass("invalidinput"):g&&g.addClass("invalidinput");m&&this.input.append('<div class="error">'+m+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var g=90;var m=i18n.latlon_error.lat}else g=180,m=i18n.latlon_error.lon;var q=this.degInput.val(),b=this.minInput.val(),a=this.secInput.val(),d=[];if(""===q&&""===b&&""===a)return"";q=parseInt(q,10)||0;b=parseInt(b,10)||0;a=parseFloat(a)||0;60<=Math.abs(b)&&(this._showError(this.minInput),d.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),d.push(i18n.latlon_error.sec));b=Math.abs(q)+b/60+a/3600;
if(!d.length&&b>g||q>g)this._showError("all"),d.push(m);return d.length?(this._showError(null,d.join(", ")),null):(0>q?-1:1)*b},_validateDecimal:function(){this._removeErrors();var g=this.options.type,m=i18n.latlon_error.format;if("lat"==g){var q=90;var b=i18n.latlon_error.lat}else q=180,b=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,g);null===a?this._showError(this.decimalInput,m):Math.abs(a)>q&&(this._showError(this.decimalInput,b),a=null);return a},_parse:function(g,
m){var q="lat"==m?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,d=m=0,f=0;if(g.match(b))return a=g.replace(b,"$1|$2|$3").split("|"),(g=a[0]||a[2])&&(g=q[g]),m=parseFloat(a[1]),g&&Math.abs(m)!=m&&(g=null),g&&(m*=g),m;if(g.match(a)){a=g.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(g=a[0]||a[7])&&
(g=q[g]);q=[];b=[];var h,p;for(p=1;6>p;p+=2){var l=a[p];(h=a[p+1])?(q.push(parseFloat(l)||0),b.push(h)):l&&(q.push(parseFloat(l)),b.push(null))}if(a=q.length){for(p=1;p<a;p++)q[p]=Math.abs(q[p]);l=q[0];Math.abs(l)!=l&&(g=1);if(1==a)h=b[0],'"'==h?f=q[0]:"'"==h?d=q[0]:h&&"\u00b0"!=h||(m=q[0]);else if(2==a)if(a=b[0],b=b[1],"\u00b0"==a)m=q[0],'"'==b?f=q[1]:"'"!=b&&b||(d=q[1]);else if(a){if("'"!=a||b&&'"'!=b)return null;d=q[0];f=q[1]}else'"'==b?(d=q[0],f=q[1]):"'"!=b&&b||(m=q[0],d=q[1]);else{if(b[0]&&
"\u00b0"!=b[0]||b[1]&&"'"!=b[1]||b[2]&&'"'!=b[2])return null;m=q[0];d=q[1];f=q[2]}m=m+d/60+f/3600;g&&(m*=g);return m}}return null},_bindEvents:function(){var g=this,m=this.eventNamespace;this.dmsInput.find("input").bind("change"+m,function(){var q=g._validateDMS();null!==q?c(g.element).val(q).change():c(g.element).val(g.defaultValue).change()});this.decimalInput.bind("change"+m,function(){var q=g._validateDecimal();null!==q?(c(g.element).val(q).change(),g.decimalInput.val(q)):c(g.element).val(g.defaultValue).change()});
c(this.element).bind("setvalue"+m,function(){g.refresh()});return!0},_unbindEvents:function(){var g=this.eventNamespace;this.input&&this.input.find("input").unbind(g);c(this.element).unbind(g);return!0}})})(jQuery);
