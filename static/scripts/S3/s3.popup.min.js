function s3_popup_refresh_caller(a){var b=getQueryParams(document.location.search),c=window.parent,p,l,g,f=b.refresh;if(void 0!==f){isNaN(parseInt(f))||c.location.reload(!0);var d=c.$("#"+f);if(d.hasClass("dl")){var h=b.record;void 0!==h?d.datalist("ajaxReloadItem",h):d.datalist("ajaxReload")}else if(d.hasClass("s3-organizer"))try{d.organizer("reload")}catch(e){}else if(d.children("div").hasClass("s3-hierarchy-tree"))try{d.hierarchicalcrud("reload")}catch(e){}else try{d.dataTable().fnReloadAjax()}catch(e){}var w=
c.S3.gis.maps;if("undefined"!=typeof w)for(g in w){var m=w[g];h=f.replace(/-/g,"_");a=m.layers;b=0;for(l=a.length;b<l;b++){var k=a[b];if(k.s3_layer_id==h){var z=k.strategies;k=0;for(p=z.length;k<p;k++){var A=z[k];if("OpenLayers.Strategy.Refresh"==A.CLASS_NAME){A.refresh();break}}break}}}c.$(".filter-form").trigger("dataChanged",f);c.S3.popup_remove()}else if(h=b.refresh_layer,"undefined"!=typeof h){if(w=c.S3.gis.maps,"undefined"!=typeof w)for(g in"undefined"!=h&&(h=parseInt(h)),f=c.i18n.gis_draft_layer,
w)for(m=w[g],a=m.layers,b=0,l=a.length;b<l;b++)if(k=a[b],k.s3_layer_id==h)for(z=k.strategies,k=0,p=z.length;k<p;k++){if(A=z[k],"OpenLayers.Strategy.Refresh"==A.CLASS_NAME){A.refresh();break}}else if(k.name==f){for(;m.popups.length;)m.removePopup(m.popups[0]);p=k.features;for(k=p.length-1;0<=k;k--)p[k].destroy()}}else if(g=b.node)h=c.$("#"+b.hierarchy),g=c.$("#"+g),h&&g&&h.hierarchicalcrud("refreshNode",g),c.S3.popup_remove();else if(g=b.agent,"undefined"!=typeof g)h="undefined"!=typeof a?[a]:[],c.$("#"+
g).trigger("configSaved",h);else if("undefined"!=typeof b.level)c.S3.popup_remove();else{var n=b.caller;if(void 0===n)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),c.S3.popup_remove();else if(s3_debug("Caller",n),g=b.person_id,"undefined"!=typeof g)c.$("#"+n).val(g).change(),c.S3.popup_remove();else{a=b.child;f=b.prefix;g=b.optionsVar;h=b.optionsValue;var B=b.parent;l=""+c.location;m=new RegExp(".*\\"+S3.Ap+"\\/");if("undefined"===typeof a){a=(""+window.location).replace(m,
"");a=a.split("?")[0].split("/");var x=a[1].split(".")[0]+"_id"}else x=a;s3_debug("childResource",x);a=l.replace(m,"");"undefined"===typeof B?(b=n.replace("_"+x,""),s3_debug("parentField",b),l=b.replace(/_.*/,""),b=b.replace(l+"_",""),a=a.split("?")[0].split("/"),l=null,f||(f=a[0]),m=a[1],2<a.length&&(null!==a[2].match(/\d*/)?3<a.length&&(l=a[3]):l=a[2]),null!==l&&b!=m&&b==l&&(b=m+"/"+l)):(b=B,f||(a=l.replace(m,""),a=a.split("?")[0].split("/"),f=a[0]));s3_debug("parentResource",b);s3_debug("lookupPrefix",
f);s3_debug("optionsVar",g);s3_debug("optionsValue",h);f=S3.Ap.concat("/"+f+"/"+b+"/options.s3json?field="+x);"undefined"!==typeof g&&"undefined"!==typeof h&&(f+="&"+g+"="+h);d=c.$("#"+n);s3_debug("callerWidget",d);var K="sub_"==n.substring(0,4),F=c.$("#dummy_"+n),G=void 0!==F.val();s3_debug("hasDummy",G);var D=d.hasClass("checkboxes-widget-s3"),H=d.hasClass("s3-hierarchy-input"),E;if(D){var L=c.$("#"+n+" tbody tr:first").children().length;var r=[]}else{var M=c.$("#"+n+" >option");(E="select"==d.prop("tagName").toLowerCase())?
r=[]:f=H?f+"&hierarchy=1&only_last=1":f+"&only_last=1"}var y=1,I="";$.getJSONS3(f,function(e){var u=0;if((e=e.option)&&e.length)if(e.forEach(function(q){var v=q["@value"];q=q.$;void 0===q&&(q="");if(E)r.push(["<option value='",v,"'>",q,"</option>"].join(""));else if(D){var J="id_"+x+"-"+u;r.push(["<td><input id='",J,"' name='",x,"' value='",v,"' type='checkbox'><label for='",J,"'>",q,"</label></td>"].join(""));u++}else H&&(B=this["@parent"],d.parent().hierarchicalopts("addNode",B,v,q,!0));v=+v;!isNaN(v)&&
v>y&&(y=v,I=q)}),G&&(F.val(I),d.val(y).change()),E){if(K){var t=["_0","_none","_default"],N=n.split("_").slice(0,-1).join("_");for(e=0;e<t.length;e++){var O=t[e];c.$("#"+N+O).empty().append(r.join(""))}}else M.remove(),d.append(r.join("")).val(y).change();d.val(y).change();d.prop("disabled",!1);if(d.hasClass("multiselect-widget")&&d.multiselect("instance"))try{d.multiselect("refresh")}catch(q){}}else{if(D){var C=[];c.$("#"+n+" input").each(function(){$(this).prop("checked")&&C.push($(this).val())});
t=[];for(e=u=0;e<r.length;e++)0===u?(t.push("<tr>"),t.push(r[e]),u++):u==L-1?(t.push(r[e]),t.push("</tr>"),u=0):(t.push(r[e]),u++);d.html(t.join(""));C.push(y);for(e=0;e<C.length;e++)c.$("#"+n+' input[value="'+C[e]+'"]').prop("checked",!0)}}else s3_debug("No options available to refresh parent field");c.S3.popup_remove()})}}}
function getQueryParams(a){a=a.substring(1);var b={};if(a){a=a.split("&");for(var c,p=0,l=a.length;p<l;p++)c=a[p].split("="),b[decodeURIComponent(c[0])]=decodeURIComponent(c[1])}return b};
